---
id: US-050
title: Define Architectural Layer Standards
actor: Platform Architect
goal: Define and manage canonical architectural layer types (presentation, domain, infrastructure) at the organization level
benefit: Establishes consistent architectural patterns across all systems and enables layer-based analysis
capability: CAP-013
status: planned
priority: high
roadmapItems:
  - ROAD-041
relatedStories:
  - US-049
  - US-051
created: 2026-02-17
updated: 2026-02-17
---

# US-050: Define Architectural Layer Standards

## Story

**As a** Platform Architect  
**I want to** define and manage canonical architectural layer types at the organization level  
**So that** all systems follow consistent patterns and I can analyze layer-based quality metrics

## Acceptance Criteria

### Creating Layer Types

- [ ] Can create a new layer type with name and description
- [ ] Can specify layer's typical responsibilities
- [ ] Can provide naming conventions (e.g., "Controllers", "Services", "Repositories")
- [ ] System enforces unique layer type names
- [ ] Layer types are organization-wide (not per-node)

### Updating Layer Types

- [ ] Can update layer type name, description, and responsibilities
- [ ] Can modify naming conventions
- [ ] Changes apply to all systems using this layer type
- [ ] System maintains historical assignments to nodes

### Deleting Layer Types

- [ ] Can delete a layer type not referenced by any nodes
- [ ] System blocks deletion if layer type is assigned to any node
- [ ] System provides list of nodes using the layer type
- [ ] Can reassign nodes to different layer type before deletion

### Querying Layer Types

- [ ] Can list all layer types in the organization
- [ ] Can retrieve layer type by ID with full details
- [ ] Can view all nodes assigned to a layer type
- [ ] Can see usage statistics per layer type

## Implementation Notes

### API Endpoints (5)

1. `POST /api/v1/taxonomy/layer-types` - Create layer type
2. `GET /api/v1/taxonomy/layer-types` - List layer types
3. `GET /api/v1/taxonomy/layer-types/:id` - Get layer type details
4. `PATCH /api/v1/taxonomy/layer-types/:id` - Update layer type
5. `DELETE /api/v1/taxonomy/layer-types/:id` - Delete layer type

### Port Interface Methods

```typescript
// From TaxonomyRepository port
createLayerType(layerType: LayerType): Promise<LayerType>
getLayerTypeById(id: string): Promise<LayerType | null>
getAllLayerTypes(): Promise<LayerType[]>
updateLayerType(id: string, updates: Partial<LayerType>): Promise<LayerType>
deleteLayerType(id: string): Promise<void>
getNodesForLayerType(layerTypeId: string): Promise<TaxonomyNode[]>
```

### File-Based Adapter

Layer types stored in YAML files:
```
data/taxonomy/layer-types/
  ├── presentation.yaml
  ├── application.yaml
  ├── domain.yaml
  └── infrastructure.yaml
```

Each file contains:
```yaml
id: layer-type-001
name: Presentation
description: User interface and API controllers
responsibilities:
  - Handle HTTP requests/responses
  - Input validation
  - Authentication/authorization
  - View rendering or JSON serialization
namingConventions:
  - Controllers
  - Views
  - DTOs
  - Validators
examples:
  - UserController.ts
  - ProductView.tsx
  - CreateOrderDTO.ts
createdAt: 2026-02-17T10:00:00Z
updatedAt: 2026-02-17T10:00:00Z
```

## UI Components

### Layer Type Management Page

- List view of all layer types
- Add/Edit/Delete buttons
- Usage statistics (how many nodes per type)
- Search and filter

### Layer Type Detail View

- Full layer type information
- List of all nodes using this layer type
- Edit form with validation
- Cannot delete if nodes exist

### Layer Type Assignment (in Node Management)

- Dropdown to select layer type when creating layer nodes
- Only available when `nodeType: "layer"`
- Shows layer type's naming conventions as guidance

## BDD Scenarios

```gherkin
@US-050 @CAP-013 @ROAD-041
Feature: Manage Architectural Layer Types

  Background:
    Given I am authenticated as a Platform Architect
    And the taxonomy repository is initialized

  Scenario: Create a presentation layer type
    When I create a layer type with:
      | name            | Presentation                          |
      | description     | User interface and API controllers    |
      | responsibilities| HTTP, validation, auth                |
      | conventions     | Controllers, Views, DTOs              |
    Then the layer type is created successfully
    And the layer type has a unique ID
    And the layer type is available organization-wide

  Scenario: Prevent duplicate layer type names
    Given a layer type "Presentation" exists
    When I try to create another layer type "Presentation"
    Then the creation fails with error "Layer type name already exists"

  Scenario: Update layer type responsibilities
    Given a layer type "Domain" exists
    When I update the layer type with:
      | responsibilities | Business logic, aggregates, domain events |
      | conventions      | Aggregates, Entities, ValueObjects        |
    Then the layer type is updated successfully
    And all nodes using "Domain" layer type see updated guidance

  Scenario: Block deletion of layer type in use
    Given a layer type "Presentation" exists
    And a layer node "Web Controllers" is assigned layer type "Presentation"
    When I try to delete layer type "Presentation"
    Then the deletion fails with error "Layer type is in use"
    And the error lists: "Web Controllers"

  Scenario: Delete unused layer type
    Given a layer type "Legacy" exists
    And no nodes use layer type "Legacy"
    When I delete layer type "Legacy"
    Then the layer type is deleted successfully
    And the layer type is no longer available

  Scenario: Reassign nodes before deletion
    Given a layer type "Old Presentation" exists
    And a layer type "New Presentation" exists
    And nodes "ControllerA", "ControllerB" use "Old Presentation"
    When I reassign "ControllerA", "ControllerB" to "New Presentation"
    And I delete layer type "Old Presentation"
    Then the deletion succeeds
    And "ControllerA", "ControllerB" are assigned to "New Presentation"

  Scenario: View layer type usage statistics
    Given layer types exist:
      | name           |
      | Presentation   |
      | Domain         |
      | Infrastructure |
    And nodes are assigned:
      | node        | layerType      |
      | Controller1 | Presentation   |
      | Controller2 | Presentation   |
      | DomainModel | Domain         |
    When I view layer type usage statistics
    Then I see:
      | layerType      | nodeCount |
      | Presentation   | 2         |
      | Domain         | 1         |
      | Infrastructure | 0         |

  Scenario: List all nodes for a layer type
    Given a layer type "Domain" exists
    And layer nodes exist:
      | name              | layerType |
      | Order Aggregate   | Domain    |
      | Customer Entity   | Domain    |
      | Payment Service   | Domain    |
    When I view nodes for layer type "Domain"
    Then I see 3 nodes: "Order Aggregate", "Customer Entity", "Payment Service"

  Scenario: Create layer node with layer type assignment
    Given a layer type "Presentation" exists
    And a system node "Katalyst" exists
    When I create a layer node with:
      | name        | Web Controllers     |
      | nodeType    | layer               |
      | parent      | Katalyst            |
      | layerTypeId | Presentation        |
    Then the layer node is created successfully
    And the node's layer type is "Presentation"
    And the node appears in "Presentation" layer type usage

  Scenario: Update layer node's layer type
    Given layer types "Presentation" and "Application" exist
    And a layer node "API Controllers" with layerType "Presentation" exists
    When I update node "API Controllers" with layerType "Application"
    Then the node's layer type is updated to "Application"
    And "Presentation" usage count decreases by 1
    And "Application" usage count increases by 1
```

## Dependencies

- **CAP-013**: System Taxonomy Management
- **ROAD-041**: Taxonomy CRUD Operations (Phase 1)
- **US-049**: Add Organizational Systems (layer nodes must exist)

## Related Stories

- **US-049**: Add Organizational Systems to Taxonomy
- **US-051**: Map Capabilities to Nodes (capabilities can be analyzed by layer)

## Technical Notes

### Validation Rules

1. **Name uniqueness**: Layer type names must be unique organization-wide
2. **Deletion protection**: Cannot delete layer type with active node assignments
3. **Immutability**: Layer type ID cannot change after creation
4. **Naming conventions**: Should be arrays of common patterns (not enforced, just guidance)

### Layer Type vs Node Type

**Important distinction:**

- **Layer Type** (`LayerType`): Organization-wide canonical architectural pattern (e.g., "Presentation", "Domain", "Infrastructure")
  - Stored in `layerTypes` table
  - Metadata about what this layer typically does
  - Used for cross-system analysis

- **Node Type** (`TaxonomyNode.nodeType: "layer"`): Specific instance of a layer in a system
  - Stored in `nodes` table
  - References a layer type via `layerTypeId`
  - Example: "Katalyst Web Controllers" is a node with `nodeType: "layer"` and `layerTypeId: "presentation"`

### Common Layer Types

Standard layer types most organizations define:

1. **Presentation**: Controllers, Views, APIs
2. **Application**: Use cases, orchestration, workflows
3. **Domain**: Business logic, aggregates, domain events
4. **Infrastructure**: Repositories, adapters, external services
5. **Cross-Cutting**: Logging, monitoring, security

### Performance Considerations

- Cache layer types in memory (rarely change, read-heavy)
- Index nodes by `layerTypeId` for fast filtering
- Precompute usage statistics (or use materialized views)

### Dual Persistence

- **SQLite adapter**: Fast queries, referential integrity
- **File adapter**: Human-readable, version-controlled
- Both adapters must implement same `TaxonomyRepository` port

## Example Usage

### Creating Standard Layer Types

```typescript
const layerTypes = [
  {
    name: "Presentation",
    description: "User interface and API controllers",
    responsibilities: ["Handle HTTP requests", "Input validation", "Authentication"],
    namingConventions: ["Controllers", "Views", "DTOs"]
  },
  {
    name: "Domain",
    description: "Business logic and domain models",
    responsibilities: ["Business rules", "Aggregates", "Domain events"],
    namingConventions: ["Aggregates", "Entities", "ValueObjects"]
  },
  {
    name: "Infrastructure",
    description: "External integrations and persistence",
    responsibilities: ["Database access", "External APIs", "File I/O"],
    namingConventions: ["Repositories", "Adapters", "Clients"]
  }
];

for (const lt of layerTypes) {
  await taxonomyRepo.createLayerType(lt);
}
```

### Assigning Layer Type to Node

```typescript
// Create a layer node
const webControllers = await taxonomyRepo.createNode({
  name: "Web Controllers",
  nodeType: "layer",
  parentId: "katalyst-system-id",
  layerTypeId: "presentation-layer-type-id",
  description: "REST API controllers for web clients"
});

// Query all presentation layer nodes
const presentationLayers = await taxonomyRepo.getNodesForLayerType("presentation-layer-type-id");
```

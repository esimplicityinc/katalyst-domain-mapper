---
id: US-052
title: Configure System Environments
actor: Platform Engineer
goal: Define and manage environments (dev, staging, production) across systems to track deployment topology
benefit: Enables environment-specific analysis, deployment tracking, and ensures proper environment segregation
capability: CAP-013
status: planned
priority: medium
roadmapItems:
  - ROAD-041
relatedStories:
  - US-049
  - US-051
created: 2026-02-17
updated: 2026-02-17
---

# US-052: Configure System Environments

## Story

**As a** Platform Engineer  
**I want to** define and manage environments across systems  
**So that** I can track deployment topology and ensure proper environment segregation

## Acceptance Criteria

### Creating Environments

- [ ] Can create a new environment with name and description
- [ ] Can specify environment type (development, staging, production, etc.)
- [ ] Can assign environment to one or more nodes
- [ ] Can add environment-specific metadata (URLs, regions, tags)
- [ ] System enforces unique environment names
- [ ] System validates that all target nodes exist

### Updating Environments

- [ ] Can update environment name, description, and metadata
- [ ] Can add or remove node assignments
- [ ] Can change environment type
- [ ] Changes are reflected in all related nodes

### Deleting Environments

- [ ] Can delete an environment not referenced by any nodes
- [ ] System blocks deletion if environment is assigned to nodes
- [ ] System provides list of assigned nodes
- [ ] Can unassign all nodes before deletion

### Querying Environments

- [ ] Can list all environments with filtering by type
- [ ] Can retrieve environment by ID with all node assignments
- [ ] Can fetch all environments for a specific node
- [ ] Can search environments by name or tags
- [ ] Can view environment topology (which nodes are deployed where)

## Implementation Notes

### API Endpoints (5)

1. `POST /api/v1/taxonomy/environments` - Create environment
2. `GET /api/v1/taxonomy/environments` - List environments (with filters)
3. `GET /api/v1/taxonomy/environments/:id` - Get environment details
4. `PATCH /api/v1/taxonomy/environments/:id` - Update environment
5. `DELETE /api/v1/taxonomy/environments/:id` - Delete environment

### Port Interface Methods

```typescript
// From TaxonomyRepository port
createEnvironment(env: Environment): Promise<Environment>
getEnvironmentById(id: string): Promise<Environment | null>
getAllEnvironments(filters?: EnvironmentFilters): Promise<Environment[]>
updateEnvironment(id: string, updates: Partial<Environment>): Promise<Environment>
deleteEnvironment(id: string): Promise<void>
getEnvironmentsForNode(nodeId: string): Promise<Environment[]>
getNodesForEnvironment(environmentId: string): Promise<TaxonomyNode[]>
```

### File-Based Adapter

Environments stored in YAML files:
```
data/taxonomy/environments/
  ├── dev.yaml
  ├── staging.yaml
  └── production.yaml
```

Each file contains:
```yaml
id: env-001
name: Production
description: Production environment for customer-facing services
environmentType: production
metadata:
  urls:
    - https://katalyst.example.com
    - https://api.katalyst.example.com
  regions:
    - us-east-1
    - eu-west-1
  tags:
    - customer-facing
    - high-availability
nodeAssignments:
  - node-001  # Katalyst Intelligence
  - node-002  # FOE Scanner
  - node-003  # Web UI
createdAt: 2026-02-17T10:00:00Z
updatedAt: 2026-02-17T10:00:00Z
```

## UI Components

### Environment Management Page

- List view of all environments
- Filter by environment type
- Add/Edit/Delete buttons
- Search by name or tags
- Color-coded by type (dev=green, staging=yellow, prod=red)

### Environment Detail View

- Full environment information
- List of assigned nodes (with links)
- Metadata display (URLs, regions, tags)
- Topology visualization
- Edit form with validation

### Node Detail View Enhancement

- Add "Environments" section showing which environments this node is deployed to
- Quick-add environment button
- Remove environment button

### Environment Topology Map

- Visual representation of which nodes are in which environments
- Color-coded by environment type
- Filterable by system or subdomain
- Export to PNG/SVG

## BDD Scenarios

```gherkin
@US-052 @CAP-013 @ROAD-041
Feature: Manage System Environments

  Background:
    Given I am authenticated as a Platform Engineer
    And the taxonomy repository is initialized
    And nodes exist:
      | id   | name                  | nodeType        |
      | n-1  | Katalyst Intelligence | subdomain       |
      | n-2  | FOE Scanner           | bounded-context |

  Scenario: Create a production environment
    When I create an environment with:
      | name             | Production                          |
      | description      | Customer-facing production          |
      | environmentType  | production                          |
      | urls             | https://katalyst.example.com        |
      | regions          | us-east-1, eu-west-1                |
      | tags             | customer-facing, high-availability  |
      | nodes            | n-1, n-2                            |
    Then the environment is created successfully
    And the environment has a unique ID
    And the environment is assigned to nodes "Katalyst Intelligence", "FOE Scanner"

  Scenario: Prevent duplicate environment names
    Given an environment "Production" exists
    When I try to create another environment "Production"
    Then the creation fails with error "Environment name already exists"

  Scenario: List all environments for a node
    Given environments exist:
      | name       | type        | nodes |
      | Dev        | development | n-1   |
      | Staging    | staging     | n-1   |
      | Production | production  | n-2   |
    When I list environments for node "n-1" (Katalyst Intelligence)
    Then I see 2 environments: "Dev", "Staging"

  Scenario: Update environment metadata
    Given an environment "Production" exists with:
      | urls | https://katalyst.example.com |
    When I update the environment with:
      | urls    | https://katalyst.example.com, https://api.katalyst.example.com |
      | regions | us-east-1, eu-west-1                                           |
    Then the environment is updated successfully
    And the environment has 2 URLs
    And the environment has 2 regions

  Scenario: Add node to environment
    Given an environment "Production" assigned to node "n-1"
    When I add node "n-2" to the environment
    Then the environment is assigned to nodes "n-1", "n-2"
    And both nodes show "Production" in their environments list

  Scenario: Remove node from environment
    Given an environment "Production" assigned to nodes "n-1", "n-2"
    When I remove node "n-1" from the environment
    Then the environment is only assigned to node "n-2"
    And node "n-1" no longer shows "Production"

  Scenario: Block environment deletion with node assignments
    Given an environment "Production" assigned to nodes "n-1", "n-2"
    When I try to delete environment "Production"
    Then the deletion fails with error "Environment has node assignments"
    And the error lists: "Katalyst Intelligence", "FOE Scanner"

  Scenario: Delete environment after unassigning all nodes
    Given an environment "Production" assigned to nodes "n-1", "n-2"
    When I unassign all nodes from "Production"
    And I delete environment "Production"
    Then the environment is deleted successfully
    And nodes "n-1", "n-2" no longer show "Production"

  Scenario: Filter environments by type
    Given environments exist:
      | name       | type        |
      | Dev        | development |
      | Staging    | staging     |
      | Production | production  |
    When I filter environments by type "production"
    Then I see 1 environment: "Production"

  Scenario: Search environments by tag
    Given environments exist:
      | name       | tags                       |
      | Production | customer-facing, critical  |
      | Staging    | internal, testing          |
      | Dev        | internal, development      |
    When I search environments by tag "internal"
    Then I see 2 environments: "Staging", "Dev"

  Scenario: View environment topology
    Given environments exist:
      | name       | nodes  |
      | Dev        | n-1    |
      | Staging    | n-1    |
      | Production | n-1, n-2 |
    When I view the environment topology
    Then I see:
      | node                  | dev | staging | production |
      | Katalyst Intelligence | ✓   | ✓       | ✓          |
      | FOE Scanner           | ✗   | ✗       | ✓          |

  Scenario: Create development environment with ephemeral metadata
    When I create an environment with:
      | name            | Dev Branch 123             |
      | description     | Feature branch environment |
      | environmentType | development                |
      | tags            | ephemeral, feature-branch  |
      | nodes           | n-1                        |
    Then the environment is created successfully
    And the environment is tagged as "ephemeral"

  Scenario: Update environment type
    Given an environment "Staging" with type "staging" exists
    When I update the environment type to "production"
    Then the environment type is updated to "production"
    And the environment is highlighted in red (production color)

  Scenario: Query nodes in production environment only
    Given environments exist:
      | name       | type       | nodes  |
      | Dev        | development| n-1    |
      | Production | production | n-1, n-2 |
    When I query nodes in production environments
    Then I see 2 nodes: "Katalyst Intelligence", "FOE Scanner"
```

## Dependencies

- **CAP-013**: System Taxonomy Management
- **ROAD-041**: Taxonomy CRUD Operations (Phase 1)
- **US-049**: Add Organizational Systems (nodes must exist)

## Related Stories

- **US-049**: Add Organizational Systems to Taxonomy
- **US-051**: Map Capabilities to Nodes (capabilities can be analyzed per environment)

## Technical Notes

### Validation Rules

1. **Name uniqueness**: Environment names must be unique organization-wide
2. **Node existence**: All assigned nodes must exist
3. **Environment type**: Must be from allowed list (development, staging, production, etc.)
4. **Deletion protection**: Cannot delete environment with active node assignments

### Environment Types

Standard environment types:

- **development**: Local or shared dev environments
- **staging**: Pre-production testing environments
- **production**: Customer-facing production environments
- **disaster-recovery**: DR/backup environments
- **ephemeral**: Temporary feature branch environments

### Environment Metadata

Common metadata fields:

- **urls**: List of URLs where environment is accessible
- **regions**: Cloud regions/availability zones
- **tags**: Custom tags for categorization
- **deploymentFrequency**: How often deployments happen
- **monitoringUrls**: Links to monitoring dashboards
- **runbookUrls**: Links to operational runbooks

### Performance Considerations

- Index environments by `environmentType` for fast filtering
- Index environment-node mappings by both `environmentId` and `nodeId`
- Cache topology matrix (recompute on assignment changes)

### Dual Persistence

- **SQLite adapter**: Fast queries, join operations, referential integrity
- **File adapter**: Human-readable, version-controlled YAML
- Both adapters must implement same `TaxonomyRepository` port

### Integration with FOE Scanner

The FOE scanner can use environment mappings to:
- Analyze deployment maturity per environment
- Track deployment frequency across environments
- Identify environment-specific issues (e.g., production-only bugs)
- Recommend environment parity improvements

### Example Use Case

**Deployment Topology Analysis:**
```typescript
// Get all production nodes
const prodEnv = await taxonomyRepo.getEnvironmentById('production-env-id');
const prodNodes = await taxonomyRepo.getNodesForEnvironment(prodEnv.id);

// Check which capabilities are in production
const prodCapabilities = new Set();
for (const node of prodNodes) {
  const caps = await taxonomyRepo.getCapabilitiesForNode(node.id);
  caps.forEach(cap => prodCapabilities.add(cap.name));
}

console.log(`Production has ${prodCapabilities.size} unique capabilities`);
```

### Security Considerations

- Restrict production environment writes to specific roles
- Audit all production environment changes
- Validate URLs are HTTPS for production environments
- Require approval workflow for production topology changes

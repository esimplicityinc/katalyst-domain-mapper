---
id: US-054
title: GitOps Workflow for Taxonomy Management
actor: Platform Engineer
goal: Manage taxonomy through GitOps workflows using version-controlled YAML files
benefit: Enables infrastructure-as-code practices, audit trails, peer review, and automated deployment of taxonomy changes
capability: CAP-013
status: planned
priority: medium
roadmapItems:
  - ROAD-041
relatedStories:
  - US-049
  - US-050
  - US-051
  - US-052
  - US-053
created: 2026-02-17
updated: 2026-02-17
---

# US-054: GitOps Workflow for Taxonomy Management

## Story

**As a** Platform Engineer  
**I want to** manage taxonomy through GitOps workflows using version-controlled YAML files  
**So that** I can track changes, require peer review, and automate deployment of taxonomy updates

## Acceptance Criteria

### File-Based Repository Adapter

- [ ] Can read taxonomy entities from YAML files in a directory structure
- [ ] Can write taxonomy entities to YAML files with proper formatting
- [ ] File adapter implements same `TaxonomyRepository` port as SQLite adapter
- [ ] File adapter validates YAML against Zod schemas before saving
- [ ] File adapter maintains referential integrity across files

### Git Integration

- [ ] Can detect changes in taxonomy YAML files via git diff
- [ ] Can commit taxonomy changes with descriptive messages
- [ ] Can create pull requests for taxonomy changes
- [ ] Can validate taxonomy changes in CI pipeline
- [ ] Can auto-deploy approved changes to database

### Validation Pipeline

- [ ] CI pipeline validates YAML syntax
- [ ] CI pipeline validates against Zod schemas
- [ ] CI pipeline checks referential integrity (all IDs exist)
- [ ] CI pipeline detects circular dependencies
- [ ] CI pipeline runs BDD scenarios against proposed changes
- [ ] CI pipeline blocks merge if validation fails

### Sync Tool

- [ ] Can sync taxonomy from files to database (one-way: files → DB)
- [ ] Can detect and report conflicts (entity exists in both with different data)
- [ ] Can perform dry-run sync (show changes without applying)
- [ ] Can batch import multiple files in transaction
- [ ] Can rollback sync on any error

### Audit and History

- [ ] All taxonomy changes are tracked in git history
- [ ] Can view diff of any taxonomy change
- [ ] Can see who made each change and when (git blame)
- [ ] Can revert to previous taxonomy state (git revert)
- [ ] Can compare taxonomy across branches or commits

## Implementation Notes

### File Structure

```
data/taxonomy/
├── nodes/
│   ├── system-katalyst.yaml
│   ├── subdomain-intelligence.yaml
│   └── bounded-context-foe-scanner.yaml
├── layer-types/
│   ├── presentation.yaml
│   ├── domain.yaml
│   └── infrastructure.yaml
├── capabilities/
│   ├── user-authentication.yaml
│   ├── foe-report-generation.yaml
│   └── domain-visualization.yaml
├── capability-relationships/
│   ├── rel-001-auth-depends-session.yaml
│   └── rel-002-reports-provides-api.yaml
├── environments/
│   ├── dev.yaml
│   ├── staging.yaml
│   └── production.yaml
├── actions/
│   ├── deploy-to-production.yaml
│   └── run-unit-tests.yaml
├── tools/
│   ├── github-actions.yaml
│   └── jest.yaml
└── stages/
    ├── build.yaml
    ├── test.yaml
    └── deploy.yaml
```

### YAML File Format

All YAML files follow this structure:

```yaml
# Top-level entity properties
id: entity-001
name: Entity Name
# ... other entity-specific fields

# Metadata (automatically added by file adapter)
createdAt: 2026-02-17T10:00:00Z
updatedAt: 2026-02-17T10:00:00Z
createdBy: aaron.west@example.com
updatedBy: jane.doe@example.com
```

### CLI Commands

```bash
# Validate taxonomy files
taxonomy validate data/taxonomy/

# Sync files to database (dry run)
taxonomy sync --dry-run data/taxonomy/

# Sync files to database (apply changes)
taxonomy sync data/taxonomy/

# Export database to files
taxonomy export data/taxonomy/

# Compare file taxonomy vs database
taxonomy diff data/taxonomy/
```

### CI Pipeline (GitHub Actions example)

```yaml
name: Validate Taxonomy

on:
  pull_request:
    paths:
      - 'data/taxonomy/**/*.yaml'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install dependencies
        run: bun install
      
      - name: Validate YAML syntax
        run: taxonomy validate data/taxonomy/
      
      - name: Check referential integrity
        run: taxonomy validate --check-refs data/taxonomy/
      
      - name: Run BDD scenarios
        run: bun test:bdd @taxonomy-validation
      
      - name: Dry-run sync to test database
        run: taxonomy sync --dry-run data/taxonomy/
      
      - name: Comment on PR with validation results
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ Taxonomy validation passed!'
            })
```

### Port Interface Methods

```typescript
// From TaxonomyRepository port (file adapter implementation)
interface TaxonomyRepositoryFile implements TaxonomyRepository {
  // All standard methods from port interface
  // Plus file-specific methods:
  
  loadFromFiles(directory: string): Promise<void>
  saveToFiles(directory: string): Promise<void>
  validateFiles(directory: string): Promise<ValidationResult>
  compareWithDatabase(directory: string): Promise<DiffResult>
}
```

### Sync Tool Implementation

```typescript
class TaxonomySyncTool {
  constructor(
    private fileRepo: TaxonomyRepositoryFile,
    private dbRepo: TaxonomyRepositorySQLite
  ) {}

  async sync(directory: string, dryRun = false): Promise<SyncResult> {
    // 1. Load all entities from files
    await this.fileRepo.loadFromFiles(directory);
    
    // 2. Validate files
    const validation = await this.fileRepo.validateFiles(directory);
    if (!validation.valid) {
      throw new Error(`Validation failed: ${validation.errors.join(', ')}`);
    }
    
    // 3. Compare with database
    const diff = await this.fileRepo.compareWithDatabase(directory);
    
    // 4. Apply changes (if not dry run)
    if (!dryRun) {
      await this.applyChanges(diff);
    }
    
    return {
      added: diff.added.length,
      updated: diff.updated.length,
      deleted: diff.deleted.length,
      dryRun
    };
  }
  
  private async applyChanges(diff: DiffResult): Promise<void> {
    // Use transaction to ensure atomicity
    await this.dbRepo.transaction(async () => {
      // Add new entities
      for (const entity of diff.added) {
        await this.createEntity(entity);
      }
      
      // Update existing entities
      for (const entity of diff.updated) {
        await this.updateEntity(entity);
      }
      
      // Delete removed entities
      for (const entity of diff.deleted) {
        await this.deleteEntity(entity);
      }
    });
  }
}
```

## UI Components

### GitOps Status Dashboard

- Shows sync status (files vs database)
- Lists pending changes (not yet synced)
- Shows last sync time and who triggered it
- Links to git commits for each change

### File Editor with Validation

- In-browser YAML editor with syntax highlighting
- Real-time Zod validation
- Shows validation errors inline
- Preview changes before committing

### Change Review Interface

- Compare file version vs database version
- Highlight differences
- Show validation results
- Approve/reject changes

## BDD Scenarios

```gherkin
@US-054 @CAP-013 @ROAD-041
Feature: GitOps Workflow for Taxonomy

  Background:
    Given I am authenticated as a Platform Engineer
    And the taxonomy file repository is initialized
    And git is configured with my credentials

  Scenario: Load taxonomy from YAML files
    Given YAML files exist in "data/taxonomy/"
    When I run "taxonomy validate data/taxonomy/"
    Then all YAML files are validated successfully
    And no referential integrity errors are found

  Scenario: Detect YAML syntax error
    Given a YAML file "data/taxonomy/nodes/invalid.yaml" with syntax error
    When I run "taxonomy validate data/taxonomy/"
    Then the validation fails with error "Invalid YAML syntax"
    And the error shows file: "data/taxonomy/nodes/invalid.yaml"
    And the error shows line number

  Scenario: Detect referential integrity error
    Given a capability "cap-001" references node "node-999"
    And node "node-999" does not exist
    When I run "taxonomy validate --check-refs data/taxonomy/"
    Then the validation fails with error "Referenced node does not exist"
    And the error shows: "cap-001 references non-existent node-999"

  Scenario: Dry-run sync shows changes without applying
    Given the database contains:
      | id   | name   | type   |
      | n-1  | Node A | system |
    And YAML files contain:
      | id   | name   | type      |
      | n-1  | Node A | system    |
      | n-2  | Node B | subdomain |
    When I run "taxonomy sync --dry-run data/taxonomy/"
    Then I see: "1 entity to add: n-2"
    And I see: "0 entities to update"
    And I see: "0 entities to delete"
    And the database is unchanged

  Scenario: Sync applies changes to database
    Given the database contains:
      | id   | name   |
      | n-1  | Node A |
    And YAML files contain:
      | id   | name   |
      | n-1  | Node A |
      | n-2  | Node B |
    When I run "taxonomy sync data/taxonomy/"
    Then the sync succeeds
    And the database contains 2 nodes: "Node A", "Node B"
    And I see: "1 entity added: n-2"

  Scenario: Sync detects update to existing entity
    Given the database contains:
      | id   | name      | description    |
      | n-1  | Node A    | Old description|
    And YAML files contain:
      | id   | name      | description    |
      | n-1  | Node A    | New description|
    When I run "taxonomy sync data/taxonomy/"
    Then the sync succeeds
    And node "n-1" has description "New description"
    And I see: "1 entity updated: n-1"

  Scenario: Sync rolls back on error
    Given the database contains:
      | id   | name   |
      | n-1  | Node A |
    And YAML files contain:
      | id   | name   | parent |
      | n-2  | Node B | n-999  |  # Invalid parent
    When I run "taxonomy sync data/taxonomy/"
    Then the sync fails with error "Referenced parent does not exist"
    And the database is unchanged (still only has n-1)

  Scenario: Create pull request for taxonomy change
    Given I am on branch "main"
    When I create a new branch "add-new-node"
    And I create file "data/taxonomy/nodes/node-new.yaml"
    And I commit with message "Add new node for X system"
    And I push the branch
    And I create a pull request
    Then the CI pipeline validates the taxonomy files
    And the PR shows validation status

  Scenario: CI pipeline blocks invalid taxonomy
    Given I create a pull request with invalid YAML
    When the CI pipeline runs
    Then the validation fails
    And the PR is blocked from merging
    And I see validation errors in the PR comments

  Scenario: CI pipeline approves valid taxonomy
    Given I create a pull request with valid YAML
    When the CI pipeline runs
    Then the validation succeeds
    And the PR is approved for merging
    And I see "✅ Taxonomy validation passed" in PR comments

  Scenario: Auto-deploy taxonomy on merge to main
    Given a pull request with taxonomy changes is approved
    When I merge the PR to "main"
    Then the CI pipeline runs "taxonomy sync data/taxonomy/"
    And the changes are applied to the production database
    And I receive a notification: "Taxonomy synced successfully"

  Scenario: View git history for taxonomy entity
    Given a node "n-1" has been modified 3 times
    When I run "git log data/taxonomy/nodes/node-001.yaml"
    Then I see 3 commits
    And each commit shows who made the change
    And each commit shows what changed

  Scenario: Revert taxonomy change via git
    Given a capability "cap-1" was modified in commit "abc123"
    And the modification introduced a bug
    When I run "git revert abc123"
    And I push the revert commit
    And the CI pipeline syncs the taxonomy
    Then the capability is reverted to its previous state
    And the database reflects the reverted state

  Scenario: Compare taxonomy across branches
    Given branch "main" has taxonomy version A
    And branch "feature" has taxonomy version B
    When I run "taxonomy diff main feature"
    Then I see differences between versions A and B
    And the diff shows added, updated, and deleted entities

  Scenario: Export database to YAML files
    Given the database contains:
      | id   | name   |
      | n-1  | Node A |
      | n-2  | Node B |
    When I run "taxonomy export data/taxonomy-export/"
    Then YAML files are created in "data/taxonomy-export/"
    And the files contain all entities from the database
    And the files are properly formatted

  Scenario: Detect conflict between file and database
    Given the database contains:
      | id   | name      | updatedAt           |
      | n-1  | Node A v1 | 2026-02-17 10:00:00 |
    And YAML files contain:
      | id   | name      | updatedAt           |
      | n-1  | Node A v2 | 2026-02-17 09:00:00 |  # Older timestamp
    When I run "taxonomy sync data/taxonomy/"
    Then I see warning: "Conflict detected for n-1"
    And I am prompted to resolve: "Database is newer, overwrite?"
```

## Dependencies

- **CAP-013**: System Taxonomy Management
- **ROAD-041**: Taxonomy CRUD Operations (Phase 2 - File Adapter)
- **US-049**: Add Organizational Systems
- **US-050**: Define Architectural Layer Standards
- **US-051**: Map Capabilities to Nodes
- **US-052**: Configure System Environments
- **US-053**: Define Actions and Tools

## Related Stories

All taxonomy user stories (US-049 through US-053) benefit from GitOps workflow.

## Technical Notes

### Validation Rules

1. **YAML syntax**: Must be valid YAML
2. **Schema compliance**: Must validate against Zod schemas
3. **Referential integrity**: All referenced IDs must exist
4. **No circular dependencies**: Prevent cycles in relationships
5. **Unique IDs**: Entity IDs must be unique across all files

### File Naming Convention

Files named by entity ID with `.yaml` extension:
- `{entityType}-{id}.yaml`
- Examples: `node-001.yaml`, `cap-005.yaml`, `env-prod.yaml`

### Conflict Resolution Strategy

When file and database have different data for same ID:

1. **Timestamp comparison**: Newer `updatedAt` wins
2. **Manual resolution**: Prompt user if timestamps conflict
3. **Force mode**: Always use file version (dangerous)

### Performance Considerations

- Load files in parallel using `Promise.all()`
- Use streaming for large YAML files
- Cache parsed YAML in memory during validation
- Batch database operations in transaction

### Security Considerations

- Validate all YAML to prevent code injection
- Require pull request approval for production taxonomy
- Audit all sync operations
- Restrict file write access to CI/CD service account

### Benefits of GitOps Approach

1. **Audit trail**: Full history of all changes
2. **Peer review**: Pull request workflow
3. **Rollback**: Easy to revert bad changes
4. **Testing**: Validate changes before deployment
5. **Collaboration**: Multiple people can propose changes
6. **Documentation**: Commit messages explain changes
7. **Disaster recovery**: Taxonomy backed up in git

### Example Workflow

```bash
# 1. Create feature branch
git checkout -b add-new-capability

# 2. Add new capability file
cat > data/taxonomy/capabilities/cap-020-monitoring.yaml <<EOF
id: cap-020
name: Real-time Monitoring
category: observability
description: Monitor system health and performance
nodeAssignments:
  - node-005
createdAt: 2026-02-17T10:00:00Z
createdBy: aaron.west@example.com
EOF

# 3. Validate locally
taxonomy validate data/taxonomy/

# 4. Commit and push
git add data/taxonomy/capabilities/cap-020-monitoring.yaml
git commit -m "Add real-time monitoring capability"
git push origin add-new-capability

# 5. Create PR
gh pr create --title "Add real-time monitoring capability"

# 6. CI validates automatically
# 7. Teammate reviews and approves
# 8. Merge PR
# 9. CI syncs to production database automatically
```

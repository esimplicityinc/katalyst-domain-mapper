---
id: ADR-006
title: "OpenCode AI Agents for Multi-Agent Development"
status: accepted
category: architecture
scope: ".opencode/agents/"
created: "2026-02-06"
updated: "2026-02-06"
author: "Katalyst Team"
supersedes: ""
superseded_by: ""
---

# ADR-006: OpenCode AI Agents for Multi-Agent Development

## Status

**Accepted** - 2026-02-06

## Context

The Katalyst Domain Mapper has a complex governance workflow with multiple quality gates (ADR validation, BDD scenario writing, architecture review, code implementation, NFR validation). Manual enforcement of these gates is error-prone and slow. The project needs a way to:

1. Automate quality gate enforcement across the 8-state governance workflow
2. Delegate specialized tasks (BDD writing, architecture auditing, code review) to focused agents
3. Maintain separation of concerns between agent responsibilities
4. Enable parallel execution of independent quality checks
5. Provide a permission model preventing agents from overstepping their roles

## Decision

Use **OpenCode CLI** with **Claude** as the AI agent runtime, with **16+ specialized agents** following a delegation model with explicit permission boundaries.

Agent architecture:
- **Orchestrators** (2): `superpowers-orchestrator` (governance lifecycle), `main-orchestrator` (general workflow coordination)
- **Quality Gate Agents** (5): `bdd-writer`, `bdd-runner`, `architecture-inspector`, `ddd-aligner`, `ux-ui-inspector`
- **Implementation Agents** (3): `code-writer`, `ci-runner`, `site-keeper`
- **Governance Agents** (2): `change-manager`, `roadmap-addition`
- **Meta Agents** (4): `agent-creator`, `agent-editor`, `agent-analyzer`, `agent-manager`

Configuration in `opencode.json` defines:
- Tool permissions per agent (which tools each agent can use)
- Trigger phrases for automatic agent selection
- MCP server connections (fetch, g-search, playwright, context7)

## Consequences

### Positive

- Each agent has a single, well-defined responsibility (separation of concerns)
- Agents can be updated independently without affecting others
- The permission matrix prevents agents from performing unauthorized actions (e.g., BDD writer cannot modify production code)
- Orchestrators coordinate complex multi-step workflows automatically
- Skills (`.opencode/skills/`) provide domain-specific knowledge to agents on demand
- Parallel agent execution accelerates quality gate validation

### Negative

- 16+ agent definitions require maintenance as the project evolves
- Agent coordination complexity: orchestrators must handle failures and retries
- OpenCode CLI is a dependency; if it's unavailable, the workflow falls back to manual
- Token consumption increases with multiple agent invocations per workflow
- Agent prompts embed domain knowledge that can become stale

### Neutral

- Agents operate on markdown files and source code; they don't have persistent state beyond the filesystem
- Agent configurations are version-controlled alongside the code they govern
- The meta-agents (creator, editor, analyzer) enable self-improvement of the agent system

## Alternatives Considered

### Alternative 1: Single Monolithic Agent

**Description**: One large agent prompt with all governance knowledge embedded.

**Pros**:
- Simple configuration
- No inter-agent communication overhead

**Cons**:
- Prompt becomes too long, causing context window issues
- No separation of concerns; changes to one capability risk breaking others
- Cannot run quality checks in parallel
- No permission boundaries

**Why Rejected**: A single agent cannot effectively manage the diverse responsibilities across BDD, architecture, DDD, code implementation, and governance tracking.

### Alternative 2: Custom Agent Framework (LangChain / AutoGPT)

**Description**: Build a custom multi-agent system using LangChain or AutoGPT.

**Pros**:
- Full control over agent orchestration
- Custom tool integrations
- Persistent agent state via databases

**Cons**:
- Significant development effort to build and maintain
- Another codebase to manage alongside the main project
- Custom frameworks lack the mature tooling of OpenCode (file access, shell execution, browser automation)

**Why Rejected**: Building a custom agent framework is orthogonal to the project's core mission. OpenCode provides production-ready agent infrastructure with file system access, browser automation (Playwright), and web search out of the box.

### Alternative 3: CI-Only Quality Gates (No AI Agents)

**Description**: Use traditional CI/CD pipeline steps (linting, testing, static analysis) without AI agents.

**Pros**:
- Deterministic, reproducible results
- No AI API costs
- Widely understood by developers

**Cons**:
- Cannot assess subjective quality (architecture clarity, documentation quality, DDD alignment)
- Cannot generate governance artifacts (BDD scenarios, ADR drafts, change entries)
- Limited to rule-based checks; misses nuanced issues
- Governance workflow enforcement would be manual

**Why Rejected**: The governance workflow requires both deterministic checks (schema validation, test execution) and subjective assessment (architecture review, DDD alignment). AI agents provide the subjective assessment layer that CI alone cannot.

## Implementation Notes

- Agent definitions live in `.opencode/agents/` as markdown files
- `opencode.json` at the repo root configures agent registry, tool permissions, and MCP servers
- Skills in `.opencode/skills/` provide on-demand domain knowledge (DDD, TDD, BDD, Hexagonal Architecture)
- The `superpowers-orchestrator` manages the full governance lifecycle from ROAD item creation through completion
- Agent delegation follows a hub-and-spoke model: orchestrators delegate to specialists, which return results

## References

- [OpenCode Documentation](https://opencode.ai/docs)
- [.opencode/agents/](../../.opencode/agents/)
- [opencode.json](../../opencode.json)
- [Agent Architecture in AGENTS.md](../../AGENTS.md)

## Compliance

This ADR affects the following areas:
- **Road Items**: ROAD-006, ROAD-007
- **NFRs**: N/A
- **BDD Scenarios**: N/A (agent infrastructure)

---

**Template Version**: 1.0.0
**Last Updated**: 2026-02-06

---
id: CAP-022
title: "User State Persistence"
tag: "@CAP-022"
category: Technical
status: stable
description: "localStorage and URL-based persistence for user selections (model, project, tab state) that survive page refresh."
---

# CAP-022: User State Persistence

## Description

The system provides localStorage and URL-based persistence for user selections so that active context survives page refreshes, browser restarts, and navigation. When a user selects a domain model, FOE project, or navigates to a specific tab, that selection is persisted and automatically restored on the next visit. This eliminates the frustration of losing context when refreshing or navigating away.

The persistence layer is built on two shared utility modules: `storage.ts` for localStorage operations with type-safe get/set/remove helpers and graceful error handling, and `url.ts` for URL-based state management enabling bookmarkable and shareable deep links. React hooks consume these utilities to hydrate component state on mount and persist changes on update.

A key design consideration is graceful degradation when persisted state becomes stale. If a user's persisted domain model ID references a model that has since been deleted, the system detects the stale reference and falls back to a sensible default (e.g., the first available model or an empty state) rather than displaying an error or blank screen. The same pattern applies to FOE project IDs, tab selections, and any other persisted identifiers.

## Key Features

- **Model Selection Persistence**: Active domain model ID stored in localStorage and restored on page load, enabling continuity across sessions
- **Project Selection Persistence**: Active FOE project ID stored in localStorage and restored on page load, integrated with CAP-016 project management
- **Deleted Entity Handling**: Graceful fallback when a persisted ID references an entity that no longer exists — detects stale references and resets to a valid default
- **URL Deep Linking**: Route-based state encoding for bookmarkable views (e.g., `/discovery/models/abc-123/aggregates` directly opens a specific model's aggregates tab)
- **Storage Utilities**: Shared utility module (`src/utils/storage.ts`) providing type-safe `getItem<T>`, `setItem`, `removeItem` with JSON serialization and error handling; URL utilities (`src/utils/url.ts`) for consistent route parameter extraction and construction

## Architecture

```
React Components
    ↓ usePersistedState hooks
Persistence Utilities
    ├── storage.ts
    │   ├── getItem<T>(key) → T | null
    │   ├── setItem(key, value) → void
    │   ├── removeItem(key) → void
    │   └── Error handling (quota exceeded, JSON parse errors, private browsing)
    └── url.ts
        ├── buildPath(segments) → string
        ├── extractParam(param) → string | null
        └── Route parameter utilities
    ↓
Browser APIs
    ├── localStorage (persistent storage)
    └── React Router v7 (URL state via route params and search params)
```

State hydration follows a consistent pattern:
1. On mount, read persisted value from localStorage
2. Validate persisted value still exists (API check or local data comparison)
3. If valid, restore state; if stale, fall back to default
4. On state change, persist new value to localStorage and update URL

## NFR Requirements

- State restoration < 50ms (localStorage reads are synchronous, validation is async but non-blocking)
- No data leakage between sessions — each user's browser maintains independent state
- Handles corrupted localStorage gracefully — invalid JSON or missing keys return null without throwing
- Handles localStorage quota exceeded errors without crashing — logs warning and continues without persistence
- Private/incognito browsing support — functions correctly when localStorage is unavailable (falls back to in-memory)

## Personas

- **PER-001** (Engineering Team Lead) — Doesn't lose context when refreshing the page or returning to the app after a meeting — their selected model and project are automatically restored
- **PER-006** (Non-Technical Stakeholder) — Can bookmark and share direct links to specific views, ensuring consistent navigation to the content they care about

## Related Capabilities

- **CAP-016** (FOE Project Management) — Uses project selection persistence to maintain the active FOE project across page refreshes
- **CAP-009** (DDD Domain Modeling API) — Uses model selection persistence to maintain the active domain model across sessions
- **CAP-010** (Interactive Domain Visualization Engine) — Uses tab state persistence to remember the user's last-viewed visualization tab

## Related Artifacts

- **User Stories**: US-057 (Persistent Project Selection), US-066 (User State Persistence Utilities)
- **Road Items**: ROAD-029 (User State Persistence)

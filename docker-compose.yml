services:
  # ── Katalyst Domain Mapper (unified single container) ──────────────────────
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8090:8090"
    environment:
      - PORT=8090
      - DATABASE_URL=/app/data/foe.db
      - SCANNER_IMAGE=foe-scanner
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - SCAN_POLL_INTERVAL_MS=5000
      - LOG_LEVEL=info
    volumes:
      - foe-data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock  # Needed to spawn scanner containers
      - ${HOME}/Documents/Projects:/projects:ro     # Mount host projects for OpenCode to read
    restart: unless-stopped

  # ── FOE Scanner (pre-built image, used by the API to run scans) ────────────
  # This service is NOT long-running. It exists so `docker compose build`
  # builds the scanner image that the API spawns via `docker run`.
  scanner:
    build:
      context: .
      dockerfile: packages/foe-scanner/Dockerfile
    image: foe-scanner
    profiles:
      - build-only  # Prevents `docker compose up` from starting this as a service
    entrypoint: ["echo", "Scanner image built. Used by the API to run scans."]

volumes:
  foe-data:

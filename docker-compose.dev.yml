# ── Dev overrides — hot reload with source-mounted volumes ───────────────────
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up --build
#   or:  just dev-docker

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    entrypoint: ["./entrypoint-dev.sh"]
    ports: !override
      - "${API_PORT:-3001}:${API_PORT:-3001}"           # API (Bun --watch)
      - "${FRONTEND_PORT:-3002}:${FRONTEND_PORT:-3002}"  # Web UI (Vite HMR)
    volumes:
      # Mount source code for hot reload
      - ./packages/intelligence/api:/app/packages/intelligence/api
      - ./packages/intelligence/web/src:/app/packages/intelligence/web/src
      - ./packages/intelligence/web/vite.config.ts:/app/packages/intelligence/web/vite.config.ts
      - ./packages/intelligence/web/index.html:/app/packages/intelligence/web/index.html
      - ./packages/intelligence/web/tailwind.config.js:/app/packages/intelligence/web/tailwind.config.js:ro
      - ./packages/intelligence/web/postcss.config.js:/app/packages/intelligence/web/postcss.config.js:ro
      - ./packages/intelligence/drizzle:/app/packages/intelligence/drizzle
      - ./packages/foe-schemas/src:/app/packages/foe-schemas/src
      - ./packages/vocabulary/src:/app/packages/vocabulary/src
      - ./.env:/app/.env:ro
      - ./entrypoint-dev.sh:/app/entrypoint-dev.sh:ro
      - foe-data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - PORT=${API_PORT:-3001}
      - FRONTEND_PORT=${FRONTEND_PORT:-3002}
      - NODE_ENV=development
      - LOG_LEVEL=debug
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - AWS_BEARER_TOKEN_BEDROCK=${AWS_BEARER_TOKEN_BEDROCK:-}
      - AWS_REGION=${AWS_REGION:-us-east-1}
    restart: "no"
